## 基本架构

Docker采用C/S架构。Docker 守护进程 （`Daemon`）作为服务端接受来自客户端的请求，并处理这些请求（创建、运行、分发容器）。

客户端和服务端既可以运行在一个机器上，也可通过 `socket` 或者 `RESTful API` 来进行通信。

## 命名空间

Linux 命名空间（namespace）是 Linux 内核的一种功能，该功能能够将内核资源分割，使得一组进程能够看到一套资源，而另一组进程看到另一套资源。

Linux 命名空间主要用于隔离系统资源，每个命名空间内的进程只能看到当前命名空间内的资源，而看不到其他命名空间的资源。这样可以增强系统的安全性，防止进程间的相互干扰。

Linux 的命名空间主要包括以下几种类型：

- PID 命名空间：用于隔离进程 ID #例如不同用户的进程就通过pid进行隔离
- NET 命名空间：用于隔离网络接口、网络栈、防火墙规则等网络资源
- MNT 命名空间：用于隔离挂载点（文件系统）
- UTS 命名空间：用于隔离主机名和 NIS 域名
- IPC 命名空间：用于隔离 System V IPC 对象和 POSIX 消息队列
- USER 命名空间：用于隔离用户 ID 和组 ID

Docker 使用 Linux 命名空间来实现容器的隔离。每个容器都有自己的进程、网络、IPC、MNT、USER 和 UTS 命名空间。

以pid命名空间为例：

当 Docker 创建一个新的容器时，它会创建一个新的 PID 命名空间。Docker 会把容器内运行的第一个进程当作 PID 为 1 的进程，通常就是你在 Dockerfile 中指定的 CMD 或 ENTRYPOINT 命令启动的进程。这将成为容器中所有其他进程的父进程。

> 我将pid命名空间理解成一个特殊的进程，这种说法是并不恰当的
>
> 正确的说法，应该是创建一个pid命名空间(这是linux的一种特殊功能)，在其中启动一个pid为1的进程(这是docker启动的第一个进程),使得这个进程看起来好像是一个全新系统的第一个进程，此后容器内所有的进程都会成为其子进程

其他的命名空间的理解都大致相同，对于用户名空间,通过创建新的用户命名空间，Docker 可以将容器内的 root 用户映射到主机上的一个非特权用户。包括MNT命名空间都是比较重要的，对于之后的安全问题很有帮助。

> 每种命名空间在创建时都会被赋予一个独一无二的 inode 数，你可以使用`docker inspect <container_id>`命令查看这些 inode 数。

## 控制组

控制组（cgroups）是Linux 内核的一个特性，主要用于对共享资源进行隔离、限制、审计等。在Docker中，控制组具有关键的作用，主要用来分配和控制Docker容器的资源。

控制组提供以下功能：

1. 资源限制（Resource limiting）：例如memory子系统可以为进程组设定一个memory使用的上限。
2. 公平资源共享：确保各个容器可以公平地分享主机的内存、CPU、磁盘IO等资源。
3. 资源隔离：例如CPU隔离，cgroups是Linux内核的一个功能，用于限制、统计和隔离一个进程组的系统资源。

在 Linux 中，Cgroups 给用户暴露出来的操作接口是文件系统，即它以文件和目录的方式组织在操作系统的 /sys/fs/cgroup 路径下

这些目录被称为子系统，通过文件来限制资源

## 联合文件系统

联合文件系统（UnionFS）是Docker镜像和容器的技术基础，它支持对文件系统的修改作为一次提交叠加到原有的文件层，同时可以将不同目录挂载到同一个虚拟文件系统下。

我们之前简单介绍过，docker镜像是分层存储的，每一层都相当于一个目录，当我们构建完成时，所有的层级会被挂载到同一个虚拟文件系统下，我们能够在这个系统下查看到所有层级的文件。这点的实现就是通过联合文件系统。

再例如，镜像B是在镜像A的基础上进行创建的，因此A的层会被复用，共享只读层，节省了存储空间。

> 简单来说就是将几个目录挂到同一个地方，方便我们管理。

## 网络

docker运用了linux上的两个概念来实现网络--网络命名空间和虚拟网络设备(veth pair)

网络命名空间使得docker容器拥有自己的ip地址等规则

docker分别在宿主机和容器中创建一个虚拟接口用于通信(这杨一对接口称作veth pair)

当docker创建一个新容器时，会创建一个新的网络命名空间，在这个网络命名空间中为容器建立一个新的接口(通常是eth0),同时在宿主机的网络命名空间创建一个veth设备，通常为veth+随机数/字符的格式。Docker 进程会将宿主机端的veth设备接入到一个特殊的网络接口，叫做docker0网桥。docker0网桥就像一个交换机，负责转发来自容器的数据包。

> 这里其实涉及了两个命名空间，一个是容器内的网络命名空间，另一个是宿主机的



