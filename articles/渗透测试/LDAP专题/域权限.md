## Windows访问控制模型

**访问控制工作流程**

![image123123](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image123123.png)

### 访问控制模型的组成

Windows中的访问控制模型（Access Control Model），它是Windows安全性的基础构件。访问控制模型有两个主要的组成部分，访问令牌（Access Token）和安全描述符（Security Descriptor），它们分别是访问者和被访问者拥有的东西。通过访问令牌和安全描述符的内容，Windows可以确定持有令牌的访问者能否访问持有安全描述符的对象。

windows 访问控制模型是由两部分组成。

+ 访问令牌（Access Token）

包含用户的标识(User SID,Group SID**S**)，以及特权列表。

+ 安全描述符（security identifiers）。

被访问的安全对象的相关安全信息。

这里的安全对象包括但不限于

- NTFS卷上的文件和目录
- 注册表项
- 网络共享
- 服务
- Active Directory对象
- 进程等等

安全描述符标识指出对象的所有者，并且还可以包含以下访问控制列表：

1. discretionary access control list（DACL）: 用于标识哪些用户和组对目标对象有访问权限
2. system access control list（SACL）: 用于记录对安全对象访问的日志

ACL包含访问控制项（access control entries）（ACEs）的列表。每个ACE指定一组访问权限，并包含一个SID，用于标识其权限被允许、拒绝或审核的受托者。受托者可以是用户帐户、组帐户或登录会话。

### ACL(访问控制列表)

之前提到过安全描述为在被访问者手中，当访问者访问对应服务时，服务会检查访问者的Access Token,判断对应的sid和组sids与自己的ACL进行对比，决定是否允许访问。

#### ACL的作用

ACL主要有两个作用

+ 权限访问控制

  这点决定一个用能否访问安全对象

+ 日志记录功能

  记录访问成功与否

根据作用的不同，可以将ACL划分为DACL和SACL

#### ACL的分类

访问控制列表（ACL）是访问控制条目（ACE）的列表。 ACL中的每个ACE都标识一个对象（通常称这个对象为受托者，受托者可以是一个用户、用户组或者是一个登陆会话），并指定允许、拒绝或审核该受托者的访问权限。可保护对象的安全描述符可以包含两种类型的ACL：DACL和SACL。

DACL：自主访问控制列表(DACL)是安全描述符中最重要的，它里面包含零个或多个访问控制项（ACE，Access Control Entry），每个访问控制项的内容描述了允许或拒绝特定账户对这个对象执行特定操作。

SACL：系统访问控制列表（SACL） 主要是用于系统审计的，它的内容指定了当特定账户对这个对象执行特定操作时，记录到系统日志中。

##### DACL

DACL标识是否允许或拒绝访问安全对象。当进程尝试访问安全对象时，系统将检查该对象的DACL中的ACE，以确定是否授予对该对象的访问权限。

1. 如果对象没有DACL，则系统将授予所有人完全访问权限。
2. 如果对象的DACL没有ACE，则系统将拒绝所有尝试访问该对象的尝试，因为DACL不允许任何访问权限。
3. 系统依次检查ACE，直到找到一个或多个允许所有请求的访问权限的ACE，或者直到拒绝任何请求的访问权限为止。

![image-20231124142311285](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231124142311285.png)

以下是DACL对用户访问的判断

![124123](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/124123.jpg)

SRM对acl的解析是

1. 明确定义的DENYACE。
2. 明确定义的ALLOWACE
3. 继承的DENYACE。
4. 继承的ALLOWACE。

排序代表了解析顺序，对于ACE的匹配，明确的DENY是解析在明确的ALLOW之前匹配的

对于线程A，系统将读取第一条ACE并立即拒绝访问，因为拒绝访问的ACE适用于线程访问令牌中的用户。在这种情况下，系统将不检查之后的ACE。对于线程B，第一条ACE不适用，因此系统进入允许写入访问的ACE 2和允许读取和执行访问的ACE 3。

##### SACL

SACL的作用是记录访问成功与否，SACL也是由一条一条的ACE构成，每条ACE的内容是某个用户访问成功/失败 某个权限。当访问跟满足这条ACE的时候就会被记录下来。

![image-20231124144242686](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231124144242686.png)

### ACE(访问控制项)

访问控制条目（ACE）是访问控制列表（ACL）中的元素。一个ACL可以包含零个或多个ACE。每个ACE控制或监视指定受托者（Trustees）对对象的访问。

ACE有六种类型，所有安全对象都支持其中三种。其他三种类型是目录服务对象支持的特定于对象的ACE.

所有类型的ACE都包含以下访问控制信息：

- 安全标识符（SID），用于标识ACE适用于的受托者
- 一个访问掩码（Access Mask），该掩码指定了具体的访问权限（Access Rights），也就是可以对该对象执行的操作（此掩码非常重要，后续很多漏洞会用到）
- 一个位标记，指示ACE类型的标志。
- 一组位标志，指示了安全描述符所属对象的子对象是否继承这个ACE。

| 类型               | 描述                                                         |
| ------------------ | ------------------------------------------------------------ |
| Access-denied ACE  | 在自由访问控制列表（DACL）中使用，以拒绝对受托者的访问       |
| Access-allowed ACE | 在DACL中使用，以允许对受托者的访问权限。                     |
| System-audit ACE   | 当受托者尝试行使指定的访问权限时，用于系统访问控制列表（SACL）中以生成审核记录。 |

#### ACE权限

大致可以划分为3类

+ 通用权限

  就是对这个条目的通用权限，通用读，通用写等。

  WriteDacl

  AllExtendedRights

  WriteOwner

  GenericWrite

  GenericAll

  Full Control

+ 对某个属性的权限

  一个条目包含若干个属性，通用属性是对整个条目的权限。域内的ACL同时也支持某个属性的权限。

+ 扩展权限

  **User-Force-Change-Password(0299570-246d-11d0-a768-00aa006e0529)**

  可以在不知道当前目标用户的密码的情况下更改目标用户的密码

  **DS-Replication-Get-Changes(1131f6aa-9c07-11d1-f79f-00c04fc2dcd2) **和 **DS-Replication-Get-Changes-All(1131f6ad-9c07-11d1-f79f-00c04fc2dcd2)**

  对域对象具有这两个扩展权限的用户具备dcsync 权限

#### ACE继承

对象的ACL可以包含从其父容器继承的ACE。例如，注册表子项可以从注册表层次结构中位于其上方的项继承ACE。同样，NTFS文件系统中的文件可以从包含该文件的目录继承ACE。

ACE的`ACE_HEADER`结构包含一组继承标志，这些继承标志控制ACE继承以及ACE对它所连接的对象的影响。系统根据ACE继承规则解释继承标志和其他继承信息。

这些规则通过以下功能得到增强：

- 支持自动传播可继承的ACE。
- 一个标志，用于区分继承的ACE和直接应用于对象的ACE。
- 特定于对象的ACE，允许指定可以继承ACE的子对象的类型。
- 通过将除`SYSTEM_RESOURCE_ATTRIBUTE_ACE`和`SYSTEM_SCOPED_POLICY_ID_ACE`之外的安全描述符的控制位中的`SE_DACL_PROTECTED`或`SE_SACL_PROTECTED`位设置来防止DACL或SACL继承ACE的能力。

简单来说，你允许它继承，那就可以继承

## SDDL(安全描述符定义语言)

+ 存储位置  nTSecurityDescriptor

+ 存储格式 SDDL(Security Descriptor Definition Language)

安全描述符定义语言（SDDL）定义了`ConvertSecurityDescriptorToStringSecurityDescriptor`和`ConvertStringSecurityDescriptorToSecurityDescriptor`函数用来将安全描述符描述为文本字符串的字符串格式。该语言还定义了字符串元素，用于描述安全描述符的组成部分中的信息。

**使用ADfind查询**	

![image-20231126161311763](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231126161311763.png)

下面一大堆难以理解的字符就是SDDL，通过ADdind指定以sddl的格式进行输出

或者使用accessChk,支持自动解析SDDL

![image-20231126161909526](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231126161909526.png)

但该工具并不支持使用AD语法进行查询，因此还是需要知道SDDL是怎么构成的

格式是一个以空值（**null**）结尾的字符串，带有令牌（tiken），用于指示安全描述符的四个主要组成部分：所有者（O :)，主要组（G :)，DACL（D :)和SACL（S :)。

抽一条出来看看

```
O:DAG:DUD:AI(OA;;SW;72e39547-7b18-11d1-adef-00c04fd8d5cd;;S-1-5-21-754643614-3937478331-2139222398-1114)
O:owner_sid
G:group_sid
D:dacl_flags(string_ace1)(string_ace2)... (string_acen)
S:sacl_flags(string_ace1)(string_ace2)... (string_acen)
-------------------------------------------------------------------------------------------------------
O:DA  ——> ower

G:DU  -->Primary Group 

D:AI(OA;;SW;72e39547-7b18-11d1-adef-00c04fd8d5cd;;S-1-5-21-754643614-3937478331-2139222398-1114)
```

除了O和G以外，D和S就是一条条ACE，每个括号代表了一条ACE

现在把ACE拆开进行分析

每条ACE由6个字段组成，每个字段由分隔进行分割

- **ACE type** (allow/deny/audit)
  ACE 类型（允许/拒绝/审核）
- **ACE flags** (inheritance and audit settings)
  ACE 标志（继承和审核设置）
- **Permissions** (list of incremental permissions)
  权限（增量权限列表）
- **ObjectType** (GUID) 对象类型 （GUID）
- **Inherited Object Type** (GUID)
  继承的对象类型 （GUID）
- **Trustee** (SID) 受托人 （SID）

```
OA:OBJECT ACCESS ALLOWED: ONLY APPLIES TO A SUBSET OF THE OBJECT(S).允许对象访问：仅适用于对象的子集。-->ACE类型
;
ACE标志;
SW:All Validated Writes 所有已验证的写入 -->这是权限位
;
72e39547-7b18-11d1-adef-00c04fd8d5cd; -->对象类型(GUID)
Inherited Object Type(GUID);-->继承的对象类型
S-1-5-21-754643614-3937478331-2139222398-1114;-->受托人SID
```

即谁对你有权限-->SID

允许or拒绝 -->ACE类型

有什么权限-->权限位

权限能不能被继承 -->权限位，为空则代表不被继承

[ACE每个字段代表什么](https://clan8blog.wordpress.com/2016/08/08/sddl-explained/)

权限同样分为通用，扩展和某个属性的权限，上述为扩展权限，体现在多了个GUID，对应什么权限可以查表

![image-20231126205620556](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231126205620556.png)

## 利用adfind过滤ACL

adfind提供了参数-sddlfilter来过滤sddl,其语法如下

```
-sddlfilter ;;;;;
```

后面跟的参数对应的是ace条目相应的参数，值得注意的是，过滤的格式跟输出的格式要保持一致。

-rawsddl 和-sddl+++决定了是使用sid形式还是账号形式对最后一位进行解析

-rawsddl就需要sddl格式进行解析，-sddl+++会解析参数

+ 查询某个对象在域内的ACL权限

  ![image-20231126211248218](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231126211248218.png)

+ 查找更改一个对象的MSDS-AllowedToActOnBehalfOfOtherIdentity的权限

  ```
  adfind -b dc=hack,dc=com -s subtree nTSecurityDescriptor -sddl+++ -sddlfilter ;;;msDS-AllowedToActOnBehalfOfOtherIdentit;; -recmute
  ```

  ![image-20231126211826028](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231126211826028.png)

+ 查询域内具备dcsync权限的用户

  dcsync只需要两个权限就可以

  ```
  'DS-Replication-Get-Changes'     = 1131f6aa-9c07-11d1-f79f-00c04fc2dcd2
  'DS-Replication-Get-Changes-All' = 1131f6ad-9c07-11d1-f79f-00c04fc2dcd2
  ```

  ![image-20231126212348591](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231126212348591.png)

## 参考链接

[Windows Access Control](https://rootclay.gitbook.io/windows-access-control/4.-ad-zhong-de-acl)

[Windows Protocol](https://daiker.gitbook.io/windows-protocol/ldap-pian/11)