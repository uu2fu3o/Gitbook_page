## 组策略基本介绍

组策略可以控制用户帐户和计算机帐户的工作环境。他提供了操作系统、应用程序和活动目录中用户设置的集中化管理和配置。有本机组策略和域的组策略。本机组策略用于计算机管理员统一管理本机以及所有用户，域内的组策略用于域管统一管理域内的所有计算机以及域用户。这里侧重于域内的组策略

打开组策略管理(gpms.msc)，可以看到在域林里面有一条条的组策略。如下图，我们可以看到`Default Domain Policy`、`Default Domain Controller Policy`，这两条是默认的组策略

![image-20231128130532045](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128130532045.png)

对于组策略，我们一般关心两点。

- 这条组策略链接到哪里。
- 这条组策略的内容是啥。

以`Default Domain Policy`为例。

### 组策略链接

![image-20231128130728588](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128130728588.png)

这条组策略链接到hack.com整个域，也就是说在test.local域内的所有计算机，用户都会受到这条组策略的影响。链接的位置可以是站点，域，以及OU(特别注意，这里没有组，只有OU，至于为啥，可以返回去看组和OU的区别)。

![image-20231128131600863](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128131600863.png)

比如说TEST这条策略链接的是TEST这条OU，因此TEST这条OU中所有用户，计算机都会受到组策略的影响

### 组策略内容

右键组策略可以导出为htlm形式的组策略报告

![image-20231128132355234](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128132355234.png)

编辑组策略会新开一个编辑器

![image-20231128133102071](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128133102071.png)

分为计算机配置和用户配置，对应着计算机和用户。

首选项是Windows Server 2008发布后用来对GPO中的组策略提供额外的功能。策略和首选项的不同之处就在于强制性。策略是受管理的、强制实施的。而组策略首选项则是不受管理的、非强制性的。

### 组策略更新

默认情况下，客户端更新组策略的方式主要有

1. 后台轮询，查看sysvol 里面GPT.ini，如果版本高于本地保存的组策略版本，客户端将会更新本地的组策略。轮询的时间是，默认情况下，计算机组策略会在后台每隔 90 分钟更新一次，并将时间作 0 到 30 分钟的随机调整。域控制器上的组策略会每隔 5 分钟更新一次。

2. 计算机开机，用户登录时，查看sysvol 里面GPT.ini，如果版本高于本地保存的组策略版本，客户端将会更新本地的组策略。

3. 客户端强制更新，执行`gupdate /force`。

   域控强制客户端更新，执行 `Invoke-GPUpdate -Computer "hack\win10" -Target "User"`

   *如果域控制器强制客户端刷新组策略，那么不会比较域共享目录中组策略的版本*

## 组策略高级介绍

### 组策略存储

每条组策略，可以看做是存储在域级别的一个虚拟对象。我们叫做GPO，每个GPO有唯一标志。用来标识每条组策略(或者说每个GPO)

![image-20231128134747875](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128134747875.png)

GPO在域内由两个部分组成

+ GPC
+ GPT

GPC 位于LDAP中，`CN=Policies,CN=System,<BaseDn>`底下，每个条目对应一个GPC

![image-20231128135509868](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128135509868.png)

其中包含GPO属性，例如版本信息，GPO状态和其他组件设置

GPC 里面的属性gPCFileSysPath链接到GPT里面。GPT 是是一个文件系统文件夹，其中包含由.adm文件，安全设置，脚本文件以及有关可用于安装的应用程序的信息指定的策略数据。GPT位于域\Policies子文件夹中的SysVol中。基本上组策略的配制信息都位于GPT里面。

![image-20231128135957474](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128135957474.png)

通过`gPCFileSysPath`关联到GPT`\\hack.com\sysvol\hack.com\Policies\{31B2F340-016D-11D2-945F-00C04FB984F9}`这个文件夹。GPT里面包含了一些策略数据。

**组策略模板（GPT）**

组策略模板是组策略具体的策略配置信息

主要涉及两个文件夹：

- SYSVOL目录是AD域中的一个共享文件夹，在AD活动目录安装时创建。通常用来存放组策略数据和 一些脚本 配置文件，这些策略和脚本将用于传递给域成员机器。
  - 域控机器之间要自动同步域数据，SYSVOL文档允许该域内的所有DC机之间进行复制，并且所有的AD用户都可以访问它
  - 域中用户登录计算机会首先在SYSVOL文件查找GPO和启动脚本
  - 该目录由于针对的是域内所有机器和用户，所以域内中的合法用户均可以访问和执行该目录的文件
  - NETLOGON目录的挂载点位于SYSVOL\domain\SCRIPTS，主要存放的是一些脚本信息，是AD活动目录安装时候自动创建的，是在sysvol下面的一个子目录文件夹

GPT位于SYSVOL共享下的DOMAIN_NAME\Policies目录下的各个GUID文件夹内，GPT在SYSVOL共享中以容器的形式组织目录结构，以GUID标识为目录名的各个组策略配置目录包含以下内容

- **Macheine目录**：包含针对计算机的策略配置
- **User目录**：包含针对用户的策略配置
- **gpt.ini文件**：该组策略对象的一些配置信息（如版本信息、策略名称）

![image-20231128141841584](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128141841584.png)

在LDAP中通过属性gPLink来体现这个链接

![image-20231128142746913](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128142746913.png)

在域，站点，OU上面同样还有个属性gPOptions来标识组策略是否会继承。

![image-20231128143729641](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128143729641.png)

TEST这个OU位于hack.com这个域内，Default Domain Policy 这条组策略链接到 test.local 这个域，所以默认情况底下，OU 会继承，这条组策略也同时会作用于TEST这个OU。如果禁用了继承，就不会作用于TEST这个OU，gOPtions体现的就是这个属性

![image-20231128144113733](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128144113733.png)

### WMI筛选

在之前，我们通过链接，将组策略链接到站点，工作组，OU。然后作用于链接对象的计算机，用户。但是如果有新的需求，我要作用于部分计算机，用户。比如说作用于所有WIN7 的电脑，这个时候微软提供了另外一项技术，叫WMI筛选。他复用了windows 本身的wmic 技术，每一个建立的WMI筛选器都可以连接到不同的现有组策略对象，一旦产生关联与应用之后，只要组织单位中的目标计算机符合WMI筛选器所设置的条件，那么这项组策略对象将会生效。

举个例子，作用于所有大于Windows 8.1的电脑。

```
Select BuildNumber from Win32_OperatingSystem WHERE BuildNumber >= 9200
```

## 组策略相关的ACL

我们主要关心以下权限。有个需要注意的是，底下有一些权限是对某个属性的WriteProperty，但是 不管啥属性的WriteProperty，拥有(WriteDacl，WriteOwner，GenericWrite，GenericAll，Full Control)这 些权限，都包括了对某个属性的WriteProperty。

### 创建GPO的权限

创建GPO的权限其实就是对`CN=Policies,CN=System,<BaseDn>`具备CreateChild的权限。

我们可以用adfind 查询域内具备创建GPO的权限。

```
adfind -b CN=Policies,CN=System,DC=hack,DC=com -sddl+++ -s base -sdna -sddlfilter ;;"CR CHILD";;;
```

![image-20231128150742291](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128150742291.png)

### GPO链接的权限

之前我们说到在域，站点，OU上面有个属性gPLink来标识链接到这里的组策略。所以我们只要遍历所有的域，站点，OU 上面的所有ACE，如果有对gPLink属性或者gPOpptions属性的修改权限，就可以修改这个这个域/站点/OU链接的OU。

1.枚举域内的所有站点，OU

2.遍历站点

在`Configuration` Naming Contex中的过滤规则是`(objectCategory=organizationalUnit)`

```
adfind -b CN=Configuration,DC=hack,DC=com -f "(objectCategory=site)" -s subtree -dn
adfind -sites -f "(objectCategory=site)"  -dn
```

+ 遍历OU

  过滤规则是`(objectCategory=organizationalUnit)`

  ```
  adfind -b DC=hack,DC=com -f "(objectCategory=organizationalUnit)" dn
  ```

  ![image-20231128162504771](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128162504771.png)

+ 遍历所有的域，站点，OU上面的ACE对gLink或者gPOpptions的WriteProperty权限

  ```
  adfind -b OU=TEST,DC=hack,DC=com -sddl+++ -s base  -sdna -sddlfilter ;;;gPlink;;
  adfind -b OU=TEST,DC=hack,DC=com -sddl+++ -s base -sdna -sddlfilter ;;;gPOpptions;;
  ```

### 修改现有的GPO的权限

修改现有GPO的权限。

我们主要关心两个

- GPC 链接到GPT 的权限
- 修改GPT的权限

GPC 与 GPT之间的关联是GPC有个属性`gPCFileSysPath`关联到GPT

只需要查找对这个属性的修改权限即可

```
adfind -b CN=Policies,CN=System,DC=hack,DC=com nTSecurityDescriptor -sddl+++ -s subtree -sdna -sddlfilter ;;;gPCFileSysPath;; -recmute
```

查看GPT的ACL

```shell
icacls \\hack.com\sysvol\hack.com\scripts\*
icacls \\hack.com\sysvol\hack.com\policies\*
```

![image-20231128165746826](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128165746826.png)

hacker用户对第一条组策略的GPT有完全控制权，对于GPT，储存了很多组策略的配置信息，因此hacker等同于能够随意修改组策略的配置。

