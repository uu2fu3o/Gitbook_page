## SYSVOL 漏洞(MS14-025)

在早期的版本，某些组策略首选项可以存储加密过的密码，加密方式为AES 256，虽然目前AES 256很难被攻破，但是微软选择公开了私钥:)

![t016b35d9da99ba64ad](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/t016b35d9da99ba64ad.png)

主要存在于以下组策略首选项中

- 驱动器映射
- 本地用户和组
- 计划任务
- 服务
- 数据源

接下来通过设置计划任务来利用一下

![image-20231128203117459](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128203117459.png)

它会提醒你这是能被检测到的。你可以通过这段代码来检测

```
findstr /S cpassword \\hack.com\sysvol\*.xml
```

![image-20231128203324524](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128203324524.png)

![image-20231128203345548](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128203345548.png)

能看到被加密过后的cpassword,通过kali自带的gpp-decrypt能够解密该字符串

![image-20231128203926394](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128203926394.png)

不过在高版本的winserver并不能指定运行用户了，这一条计划任务是在2012上设置

## 利用组策略扩展

拿下域控之后，网络ACL无法到达的机器，可以通过组策略来横向

### 在“软件安装”下推出.msi

![image-20231128210847955](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128210847955.png)

受这条组策略影响的计算机在重启后会更新组策略，自动安装该msi包

### 推出特定的启动脚本

![image-20231128211311246](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128211311246.png)

### 计划任务

![image-20231128211713442](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128211713442.png)

## 组策略后门

### 将域帐户添加到本地管理员/ RDP组

![image-20231128212918591](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128212918591.png)

### 添加特权

可以通过组策略给某个用户授予特权。 我们用的比较多的有SeEnableDelegationPrivilege特权

![image-20231128215027741](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128215027741.png)

### 降级凭据保护

![image-20231128215245210](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128215245210.png)

### 更改现有的安全策略以启用明文密码提取

微软很早就更新了补丁来防止获取高版本windows的明文密码，但是可以修改注册表... 使 \HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest下的UseLogonCredentiald的键值为1

![image-20231128215604584](https://raw.githubusercontent.com/uu2fu3o/blog-picture/main/ldapp/image-20231128215604584.png)

### 组策略ACL 后门

组策略相关的ACL里面有提到三种特权

1. 创建GPO的权限
2. GPO链接OU的权限。
3. 修改现有的GPO的权限

即利用方式为给用户添加对某条组策略的修改权限来控制该条GPO，比如拥有修改Default Domain Policy的权限，那么这个用户就可以授予别的用户SeEnableDelegationPrivilege的权限。赋予某个用户创建GPO ，以及链接到域的权限，那么这个用户其实就等效于域管了。

### 参考链接

[Windows Protocol](https://daiker.gitbook.io/windows-protocol/ldap-pian/11)

[microsoft](https://learn.microsoft.com/en-us/previous-versions/windows/desktop/policy/group-policy-start-page)

[域渗透-利用GPO中的脚本实现远程执行](https://3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-%E5%88%A9%E7%94%A8GPO%E4%B8%AD%E7%9A%84%E8%84%9A%E6%9C%AC%E5%AE%9E%E7%8E%B0%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C)
