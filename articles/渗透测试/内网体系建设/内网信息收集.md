---
title: 内网信息收集
date: 2023-09-03T15:29:52+08:00
updated: 2023-08-17T03:14:48+08:00
categories: 
- 渗透测试
- 内网体系建设
---

## 本机信息收集

### 手动信息收集

本机信息包括操作系统、权限、内网IP地址段、杀毒软件、端口、服务、补丁更新频率、网络连接、共享、会话等。

如果是域内主机，操作系统，应用软件，补丁、服务、杀毒软件一般都是批量安装的。

1.查询网络配置信息

```
ipconfig /all
```

2.查询操作系统,软件,补丁信息

```
systeminfo
wmic qfe get Caption ,Description ,HotFixID,InstalledOn
systeminfo | findstr /B /C"OS 名称 " OS版本”
systeminfo | findstr /B /C"OS Name " OS·版本”
```

3.查看系统体系结构

```
echo %PROCESSOR_ARCHITECTURE%
```

4.查询已安装的软件及版本信息

```
wmic product get name,version
***win10中wmic已被弃用***
==>powershell
Get-WmiObject -class win32_product | Select-Object -property name,version
```

5.查询本机服务

```
wmic service list brief
```

6.查询系统进程

```
tasklist
wmic process list brief
```

**常见的杀软进程**

- 常见的杀软进程：

| 进程名                  | 软件        |
| ----------------------- | ----------- |
| 360sd.exe               | 360杀毒     |
| 360tray.exe             | 360实时保护 |
| ZhuDongFangYu.exe       | 360主动防御 |
| KSafeTray.exe           | 金山卫士    |
| SafeDogUpdateCenter.exe | 安全狗      |
| McAfee McShield.exe     | McAfee      |
| egui.exe                | NOD32       |
| AVP.exe                 | 卡巴斯基    |
| avguard.exe             | 小红伞      |
| bdagent.exe             | BitDefender |

7.查看启动程序信息

```
wmic startup get command ,caption
```

8.查看计划任务

```
schtasks /query /fo LIST /v
```

9.查看主机开机时间

```
net statistics workstation
```

10.查询用户列表

```
net user
net localgroup administrator
query user || qwinsta ==>查看当前在线用户
```

11.查看本地计算机与所连接客户端的会话(需要管理员权限)

```
net session
```

12.查询端口列表

```
netstat -ano
```

13.查询本机共享列表

```
net share
wmic share get name,path,status
```

14.查询路由表及所有可用接口的Arp缓存表

```
route print
arp -a
```

15.防火墙相关配置

```
netsh firewall show config ==>防火墙配置
关闭防火墙
winserver 2003之前：netsh firewall set opmode disable
winserver 2003之后：netsh advfirewall set allprofiles state off
```

16.查看代理

```
reg query "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings"
```

17.查询远程连接服务并开放端口

```
reg query "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlset\Control\Terminal Server\WinStations\RDP-
wmic /namespace:\\root\CIMV2\TerminalServices PATH Win32_TerminalServiceSetting WHERE (__CLASS !="") CALL SetAllowTSConnections 1
```

### 使用empire进行主机信息收集

**安装**

```
git clone --recursive https://github.com/BC-SECURITY/Empire.git
cd Empire
./setup/checkout-latest-tag.sh
sudo ./setup/install.sh
```

**使用**

使用`usemodule powershell/situational_awareness/host/winenum`模块进行信息收集，需要已经成功提权的机器

## 权限信息

```
whoami ==>查看当前权限
whoami /all ==>获取域id
net user xxx /domain  ==>获取指定用户的详细信息
ipconfig /all ==>判断是否存在域
nslookup 域名  ==>解析域名ip，用来判断dns服务器与域控是否在同一台主机上
net config workstation ==>查询当前登录域与用户信息
net time /domain ==>判断主域
若是此命令在显示域处显示WORKGROUP，则不存在域，若是报错：发生系统错误5，则存在域，但该用户不是域用户
for /L %I in (1,1,254) DO @ping -2 1 -n 1 192.168.52.%I | findstr "TTL=" ==>利用ICMP探测域内存活主机
arp -a ==>扫描探测内网
```

## 扫描端口

使用telnet进行端口扫描

```
telnet 主机名 22
```

使用metasolit进行扫描

需要用到的是auxiliar/scanner/portscan/ack、ftpbounce、syn、tcp、xmas

**获取banner**

扫描到端口后就要获取其banner信息，用于收集poc

| 端口号      | 端口说明                  | 攻击技巧                                                     |
| ----------- | ------------------------- | ------------------------------------------------------------ |
| 21/22/69    | ftp/tftp：文件传输协议    | 允许匿名上传、下载、爆破、嗅探、溢出和后门                   |
| 22          | ssh：远程连接             | 爆破OpenSSH；28个退格                                        |
| 23          | telnet：远程连接          | 爆破\嗅探、弱口令                                            |
| 25          | smtp：邮件服务            | 邮件伪造                                                     |
| 53          | DNS：域名系统             | DNS区域传输\DNS劫持\DNS缓存投毒\DNS欺骗\利用DNS隧道技术刺透防火墙 |
| 67/68       | dhcp                      | 劫持\欺骗                                                    |
| 80/443/8080 | 常见web服务端口           | web攻击、爆破、对应服务器版本漏洞                            |
| 110         | pop3                      | 爆破、嗅探                                                   |
| 139         | samba                     | 爆破\未授权访问\远程代码执行                                 |
| 143         | imap                      | 爆破                                                         |
| 161         | snmp                      | 爆破                                                         |
| 389         | ldap目录访问协议          | 注入攻击\未授权访问，弱口令                                  |
| 512/513/514 | linux rexec               | 直接使用rlogin\爆破                                          |
| 873         | rsync                     | 未授权访问\文件上传                                          |
| 1080        | socket                    | 爆破：进行内网渗透                                           |
| 1352        | lotus Domino邮件服务      | 爆破：弱口令\信息泄漏：源代码                                |
| 1433        | mssql                     | 爆破：使用系统用户登录\注入攻击\SA弱口令                     |
| 1521        | oracle                    | 爆破：TNS\注入攻击\反弹shell                                 |
| 2049        | nfs                       | 配置不当                                                     |
| 2181        | zookeeper                 | 未授权访问                                                   |
| 3306        | mysql                     | 爆破\拒绝服务\注入\提权                                      |
| 3389        | rdp                       | 爆破\Shift后门                                               |
| 3690        | SVN服务                   | SVN泄露\未授权访问                                           |
| 4848        | glassfish                 | 爆破：控制台弱口令\认证绕过                                  |
| 5000        | sybase/DB2                | 爆破\注入                                                    |
| 5432        | postgresql                | 缓冲区溢出\注入攻击\爆破：弱口令                             |
| 5632        | pcanywhere                | 拒绝服务\代码执行，抓取密码                                  |
| 5900        | vnc                       | 爆破：弱口令\认证绕过                                        |
| 6379        | redis                     | 未授权访问\爆破：弱口令                                      |
| 7001/7002   | weblogic                  | Java反序列化\控制台弱口令\控制台部署webshell                 |
| 8069        | zabbix                    | 远程命令执行\SQL注入                                         |
| 8080/8089   | JBoss/Resin/Jetty/Jenkins | 反序列化、控制台弱口令                                       |
| 9090        | websphere控制台           | 爆破：控制台弱口令\Java反序列                                |
| 9200/9300   | elasticsearch             | 远程代码执行                                                 |
| 10000       | webmin控制面板            | 弱口令                                                       |
| 11211       | memcacache                | 未授权访问                                                   |
| 27017/27018 | mongodb                   | 爆破\未授权访问                                              |
| 50000       | SAP Management Console    | 远程执行                                                     |

## 域内信息收集

```
net view /domain ==>查询域
net view /domain:域名  ==>查询域内所有计算机名
net group /domain ==>查询域内所有用户组
net group "domain computers" /domain ==>查看所有域成员计算机列表
net accounts /domain ==>获取域密码信息
nltest /domain_trusts ==>获取域信任信息
```

**关于域控机器**

```
nltest /DCLIST:域名 ==>查看域控机器名
nslookup -type=SRV \_ladp._tcp ==>查看域控主机名
net group "Domain Controllers" /domain，netdom query pdc ==>查看域控制器组
```

**域内用户信息和管理员信息**

```
net user /domain ==>查询所有域用户列表
wmic useraccount get /all ==>获取域内用户的详细信息,可以获取到用户名，描述信息，SID域名等
dsquery user ==>查看存在的user
net localgroup administrators ==>查询本地管理员组用户
net group "domain admins" /domain ==>查询域管理员用户组
net group "Enterprise Admins" /domain ==>查询管理员用户组
```

\## 定位域管理员
常规渠道有二个，日志与会话，日志是本地机器的管理员日志，可以用脚本或者内置应用wevtutil导出来看
\### 工具
[psloggedon.exe](https://docs.microsoft.com/en-us/sysinternals/downloads/psloggedon)，[netview.exe](https://github.com/mubix/netview)，[PVEFindADUser.exe](https://github.com/chrisdee/Tools/tree/master/AD/ADFindUsersLoggedOn)，powersploit的PowerView脚本，Empire的user_hunter模块等

### 查找域管理进程

#### 本机检查

net group "Domain Admins" /domain

```
tasklist /v ==>列出本机的所有进程及进程用户
net group "Domain Controllers" /domain ==> 查询域控制器列表
net group "Domain admins" /domain ==>  收集域管理员列表
收集所有活动域的会话列表 
==> NetSess -h 使用工具为NetSess.exe
==>http://www.joeware.net/freetools/tools/netsess/index.htm
```

**利用powershell收集域信息**

首先要将powershell的权限限制更改为**RemoteSigned**，这样就可以执行本地上的脚本

输入：`Get-ExecutionPolicy`，发现自己并不是RemoteSigned权限，输入：`Set-ExecutionPolicy RemoteSigned`，按Y确定即可，在本地虚拟机测试时还可以将脚本权限改为**Unrestricter**，这样可以执行来自网络与本地的任何脚本

此处要使用的脚本在PowerSploit/Recon中，将要用到的PowerView.ps1传入靶机，在powershell中打开该脚本目录并导入：`Import-Module .\PowerView.ps1`就可以进行收集了

具体命令的相关用法在`PowerSploit/Recon/READE.md`中

## 参考链接

https://xz.aliyun.com/t/7663#toc-5