---
title: 内网渗透基础知识
date: 2023-09-03T15:29:52+08:00
updated: 2023-08-21T20:22:14+08:00
categories: 
- 渗透测试
- 内网体系建设
---

## 内网工作环境

### 工作组(work group)

工作组作为资源管理模式的一种，用于对计算机行使功能进行划分，每个工作组中有若干计算机。

注意:

1.将计算机加入工作组中时，若指定的工作组不存在，则会创建一个新的工作组

2.在默认情况下，局域网内的计算机都是采用工作组的方式进行资源管理，即处在名为WORKGROUP的工作组中

### 域

域同样时资源管理模式的一种，相比于工作组这种小型的管理模式，域更适合大型的计算机网络管理，域中的所有计算机，用户账户等等，都需要通过域控机器进行统一的身份验证，通过验证的用户能够访问什么资源，有什么权限取决去用户在域中的身份，域管理员用户无疑是权限最高的用户，所以通常进行内网渗透的最终目标就是拿下域管机器

#### 单域

单域，顾名思义在整个网络环境下只存在一个域

#### 父域和子域

将一个单域划分为多个部分，被划分的单域称为父域，划分出来的部分称为子域，每个子域拥有自己的安全策略，对应管理相应的资源

命名规则：假设有有一单域名为hack.com,划分出子域asia.hack.com和ua.hack.com

​				   子域是整个域名中的一个段，各子域之间通过"."来进行划分，一个"."代表域名的一个层级

**问：域的管理员是否对子域同样具有所有权限？**

答：父域的管理员并不自动具有对子域的所有权限。域之间的权限和控制是独立管理的，并且在域的安全策略中进行配置和控制。通常情况下，父域管理员可能具有一些管理子域的权限，例如创建和删除子域、配置子域的访问控制策略、分配一部分权限给子域的管理员等。但对于子域内部的具体操作和资源访问，通常需要子域管理员单独进行授权和管理。

#### 域树

通过信任关系建立起来的域集合。域树中的命名具有连续性，域名层次越深，级别越低。

注意：域树中，域管理员只能管理本域，不能访问或者管理其他域。如果两个域之间需要互相访问，就需要建立信任关系 。

**问:两个建立信任关系的域，域管用户对另一个域具有控制权吗？** 

答：并不，具体权限需要另一域的管理员进行单独赋予                                                                                                                

#### 域林

指一个或多个没有形成连续名称空间的域树组成的域树集合，通俗来说就是两个单域划分出来的域树连在了一起，给出一张图就不难理解上面域的所有概念了

![域林演示图](E:\笔记软件\笔记\渗透测试\内网体系建设\域林演示图.png)

#### 域控制器(Domain Controller,DC)

作为域环境的核心的服务器计算机，用于在域中响应安全身份认证请求，操控着资源，权限等，简称为域控。

一个域环境可以有一台或多台域控制器，如果一台域控机器掉了，还可以通过其他域控机器维持域的正常工作

**问：域环境中有多台域控机器时，如何一次性列出**

答：利用nltest或dsqurey,具体命令如下

```
打开命令提示符（CMD）或 PowerShell。
运行以下命令：nltest /dclist:<域名>，将 <域名> 替换为你的域名。
命令会列出域中的所有域控制器。
打开命令提示符（CMD）或 PowerShell。
运行以下命令：dsquery server -forest。
命令会列出域中的所有域控制器。
```

## 活动目录(Active Directory,AD)

安装在域控制器上，为整个域环境提供集中目录管理服务的组件，存储了策略，用户，组等等资源。目录数据存储在Ntds.dit文件中。提供计算机集中管理，用户集中管理等集中管理功能

### Ntds.dit文件

二进制文件，活动目录数据库，默认路径为域控的"%SystemRoot%\ntds\ntds.dit"或“C:\Windows\NTDS”，文件中包括有关与用户的，用户密码的哈希散列值，用户组等等重要信息，该文件利用存储来系统SYSTEM文件的密钥对这些哈希值进行加密

注意：在非域环境的工作组环境中，用户的登录凭据等信息存储在本地SAM文件中

### 目录服务与LDAP

轻型目录访问协议（[Lightweight Directory Access Protocol，LDAP)，用于访问目录数据库，活动目录利用LDAP名称路径来描述对象在活动目录中的位置

https://zh.wikipedia.org/wiki/%E8%BD%BB%E5%9E%8B%E7%9B%AE%E5%BD%95%E8%AE%BF%E9%97%AE%E5%8D%8F%E8%AE%AE

### 活动目录分区

分为域分区，配置分区，架构分区

### 活动目录的查询

#### ldap按位查询

语法

```
<属性名称>：<BitFilterRule-ID> := <十进制比较值>
```

其中BitFilterRule-ID指的就是位查询规则对应的ID，如下![BitFilterRule-ID](E:\笔记软件\笔记\渗透测试\内网体系建设\BitFilterRule-ID.png)

例如查询userAccountControl属性的HOMEDIR_REQUIRED和MNS_LOGON_ACCOUN如下

```
(userAccountControl:1.2.840.113556.1.4.803:=131080)
```

#### 使用AdFind查询

域信息查询工具，可在域内任意一台机器上使用，具体语法

```
AdFind.exe [switches] [-b basedn] [-f filter] [attr list]
```

-b指定一个BaseDN作为查询的根，-f作为LDAP的过滤条件，attr list为需要显示的属性

```
AdFind.exe -b dc=hack,dc=com -f "objectClass=computer" name operatingSystem
```

查询hack.com域中的所有computer对象，并过滤对象的name和operatinfSystem属性

## 域用户与机器用户

### 域用户

域环境中的用户，域用户账户位于全局组Domain User中，而计算机本地用户账户位于本地User组中，当计算机加入域时，Domain user组会被自动添加到计算机user组中，即域用户能够登录域中任意一台计算机并执行命令

### 机器用户

一种特殊的域用户，域用户具有的属性他都有。计算机上的本地用户SYSTEM对应域中的机器账户，在域中的名称为"机器名+$",可以在计算机上利用SYSTEM用户执行域中命令

## 域用户组的分类和权限

具有相同权限的用户划为一组，对组赋予特权即对组内用户赋予特权

### 安全组权限

根据作用范围可分为域本地组，通用组和全局组

#### 域本地组

作用于本域，只能访问本域中的资源

注意：域本地组可以包含域林内任意域和通用组，全局组的用户，但无法包含其他域中的域本地组

例如：只有林根域具有通用组(Enterprise Admins)，子域的域本地组Administrator会添加通用组到域本地组中，实现根域对子域的资源访问

系统内置域本地组

```
Administrator //管理员组
Print Operators  //打印机组
Backup Operators //备份操作员组
Remote Desktop Users //远程登录组，只有该组成员才能远程登陆服务器
Account Operators //账号操作员组
Server Operators //服务器操作员组
```

#### 通用组

可作用于域林中的任一域，可包含域林中的任何域的用户账户，全局组和其他通用组，不能包含域本地组，可嵌套到其他通用组

常见系统内置通用组及其权限

```
Enterprise Admins //组织系统管理员，该组时域林根域中的一个组，对所有的域控制器具有完全的权限
Schema Admins //架构管理员组，根域中的一组，可修改活动目录
```

#### 全局组

可作用于域林中的所有域，介于域本地组和通用组之间的一种组，全局组只能包含本域的用户。可以嵌套到同一个域的另一个全局组中，也可嵌套到其他域的通用组和域本地组，全局组可以在任意位置被管理员赋予访问权限

常见系统内置全剧组和权限

```
Domain Admins //域管理员组
Domain Users //域用户组
Domain Computers //域成员主机组
Domain Controllers //域控制器组，该组成员包含域中所有域控制器
Domain Guest //域方可用户组，该组成员默认为域访客用户
Group Policy Creator Owners //新建组策略对象组，该组成员可以修改域的组策略
```

##  组织单位

组织单位(Organization Unit,OU)是一个可以将域中用户，组和计算机等对方放入其中的容器对象，是可以指派组策略或委派管理权限的最小作用域或单元。

所有组织单位在AD中都是organizationUnit类时可通过Adfind查询所有的OU

```
Adfind.exe -b "dc=hack,dc=com" -f "(objectClass=organizationUnit)" -dn
```

## 访问控制

### windows访问控制模型

主要有访问令牌(Acess Token)和安全描述符(Security Descriptor)两部分组成，分别由访问者和被访问者持有，对比二者判断是否有访问权限

1.访问令牌

用户登录，windows为用户创建一个访问令牌，包含了登录过程返回的SID和本地给予的用户权限策略列表，具体哪些SID内容请自行查询

2.安全描述符

安全描述符主要包含

1. 安全标识符（Security Identifier，SID）：SID是一个唯一的标识符，用于标识用户、组或其他安全主体。安全描述符中包含了与对象相关联的所有安全主体的SID。SID可以用来识别具体的用户或组，并用于权限的授权和验证。
2. 访问控制列表（Access Control List，ACL）：ACL是一个有序的条目列表，每个条目包含了一个SID以及与该SID相关联的访问权限。ACL用于定义对象的访问控制规则，决定了哪些安全主体具有对对象的特定权限（如读取、写入、执行等）。

当然还有其他三样内容

注意:SID用来标识用户账户和该用户所属的组。ACL分为DACL和SACL两种

### 访问控制列表(ACL)

ACL是访问控制项(ACE)的列表，每个访问控制项制定了一系列的访问权限，在A对B进行访问的过程中，ACL主要有两个作用，一是进行访问权限控制，判断主体能不能访问该安全对象，二是进行日志记录功能，所以安全对象的安全对象可通过两种访问控制列表DACL和SACL进行控制

1.DACL

DACL(自主访问控制列表)是安全对象的访问控制策略，其中定义了该安全对象的访问策略，DACL是由访问控制项(ACE)组成，每条ACE制定了哪些用户对哪些对象拥有什么样的访问权限。具体验证流程请自行查看，大致可归纳为，当有一主体访问对象时，对象会一条ACE一ACE的检查具体的SID是否对应，以此决定该主体有无权限访问该对象

2.SACL

系统访问控制列表(SACL),是安全主体对对象的访问行为的审计策略，同样由ACE条目构成，ACE定义了哪些行为会被哪些日志文件记录

3.查看与修改访问控制列表

利用工具lcacls,执行命令为hacker用户添加指定文件或目录(及其子目录)的完全访问控制权

```
icacls C:\Users\Willian\Desktop\Test /grant Hacker:(OI)(CI)(F) /t
```

OI代表对象继承，CI代表容器继承，F代表完全访问

## 组策略

Windows环境下管理用户账户的一种手段，提供了许多管理环境和功能。包含计算机本地组策略(非域环境)，和域组策略，域组策略可以对域中所有计算机和用户进行管理，重点了解域组策略

### 组策略对象(GPO)

包含应用于特定用户或计算机的策略信息和具体配置，在设置组策略时只需要将该组策略对象链接到指定的站点，域和组织单位，策略值就会应用到该站点，域和组织单位的所有用户和计算机

GPC由组策略容器(GPC)和组策略模板(GPT)两个组件组成，分别储存在域控制器的不同位置上，容器储存在活动目录的·域分区，策略模板在域控制器的如下文件文件夹

```
"%SYSTEMROOT%\SYSVOL\sysvlo\域名\Policies"
```

1.组策略容器

记录着该组策略对象的策略名称，标识组策略的GUID，组策略链接到的作用域，组策略模板的路径，组策略的版本信息等各种元数据，组策略容器的路径为

```
CN=Policies,CN=System,DC=hack,DC=com
```

2.组策略模板

以GUID标识的各组策略配置目录中包含以下内容

```
MACHINE:包含一些针对该组策略的整个作用域中计算机的具体配置
USER: 包含一些针对该组策略的整个作用域中用户的具体配置
GPT.INI: 包含一些关于该组策略的策略名称，版本信息等配置信息
```

