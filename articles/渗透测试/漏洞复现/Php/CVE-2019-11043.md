---
title: CVE-2019-11043
date: 2023-09-03T15:29:52+08:00
updated: 2023-08-02T16:03:10+08:00
categories: 
- 渗透测试
- 漏洞复现
- Php
---

### 漏洞简介

当nginx配置不当时，会导致php-fpm远程任意代码执行。

### 漏洞复现

可以使用网上公开的exp进行复现

```go
go get github.com/neex/phuip-fpizdam
go run . "http://192.168.121.140:8080/index.php"
```

即可在index.php下执行命令![2019-1](E:\笔记软件\笔记\渗透测试\漏洞复现\Php\2019-1.png)

也可以使用别的脚本，例如

https://github.com/kriskhub/CVE-2019-11043

```
python3 exp.py --target
```

### 漏洞分析

**php-fpm**

PHP-FPM（FastCGI Process Manager）是一个用于管理 PHP FastCGI 进程的工具，是 PHP 官方推荐的 PHP FastCGI 进程管理器之一。它可以在运行 PHP 应用程序的 Web 服务器和 PHP 解释器之间建立一个 FastCGI 连接，以便更有效地处理 PHP 脚本请求

**nginx配置**

```
location ~ [^/]\.php(/|$) {
  ...
  fastcgi_split_path_info ^(.+?\.php)(/.*)$;
  fastcgi_param PATH_INFO       $fastcgi_path_info;
  fastcgi_pass   php:9000;
  ...
}
```

当缺少脚本存在检查时可用

**利用条件**

Nginx + php-fpm，必须转发到 php-fpm

必须有一个 `PATH_INFO` 通过语句 `fastcgi_param PATH_INFO $fastcgi_path_info;` 赋值的变量。还必须 `SCRIPT_FILENAME` 使用 （可能存在常量路径而不是 `$document_root` ） 进行 `fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;` 设置

必须有一种方法可以设置为 `PATH_INFO` 空值。此漏洞利用假定 `fastcgi_split_path_info` 指令存在并包含以 开头 `^` 和结尾 `$` 的正则表达式，因此它尝试使用换行符破坏正则表达式。

此特定漏洞利用假定在 `PATH_INFO` 配置中设置。 `REQUEST_URI`

没有文件存在检查，例如 `try_files $uri =404` 或 `if (-f $uri)` 。如果 Nginx 在 FastCGI 转发之前丢弃对不存在脚本的请求，我们的请求永远不会到达 php-fpm

此漏洞仅适用于 PHP 7+

**分析**

```c
	path_info = script_path_translated + ptlen;
	tflag = (slen != 0 && (!orig_path_info || strcmp(orig_path_info, path_info) != 0));
} else {
	path_info = env_path_info ? env_path_info + pilen - slen : NULL;
	tflag = (orig_path_info != path_info);
	path_info = (env_path_info && pilen > slen) ? env_path_info + pilen - slen : NULL;
	tflag = path_info && (orig_path_info != path_info);
}

if (tflag) {
```

根据修复部分的代码可以看出漏洞是由path_info的地址可控造成的

当`path_info`被%0a截断时，`path_info`将被置为空,当path_info为空时，pilen为空，slen人为可控，该变量来自于请求后的url的长度

```
    int ptlen = strlen(pt);
    int slen = len - ptlen;
```

```php
int len = script_path_translated_len;

len为url路径长度
当请求url为http://127.0.0.1/index.php/123%0atest.php
script_path_translated来自于nginx的配置，为/var/www/html/index.php/123\ntest.php

ptlen则为url路径第一个斜杠之前的内容长度
当请求url为http://127.0.0.1/index.php/123%0atest.php
pt为/var/www/html/index.php
```

通过将指定的地址的值置零，可以控制使`_fcgi_data_seg`结构体的`char* pos`置零,根据描述char* pos置零会影响到`FCGI_PUTENV`的结果，最终的调用结果是fcgi_hash_strndup中`h->data->pos`最低位被置为0，且str可控，可以向配置中写入数据

### 参考链接

https://paper.seebug.org/1063/

https://github.com/neex/phuip-fpizdam

https://github.com/kriskhub/CVE-2019-11043/blob/master/exploit.py